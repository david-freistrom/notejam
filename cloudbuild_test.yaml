steps:
  - name: 'gcr.io/cloud-builders/docker'
    id: Build Docker image
    args: [ 'build', '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/notejam/notejam:$COMMIT_SHA', '.' ]
  - name: 'gcr.io/cloud-builders/docker'
    id: Push Docker image
    args: [ 'push', 'us-central1-docker.pkg.dev/$PROJECT_ID/notejam/notejam:$COMMIT_SHA']
  - name: 'us-central1-docker.pkg.dev/$PROJECT_ID/notejam/notejam:$COMMIT_SHA'
    id: Run Python Unittests
    args: ['tests.py']
    entrypoint: python
  - name: 'gcr.io/cloud-builders/gcloud'
    id: Deploy Flask app into test env
    secretEnv: ['POSTGRES_PW', 'MAIL_PW']
    args:
      - run
      - deploy
      - notejam-test
      - --image
      - "us-central1-docker.pkg.dev/$PROJECT_ID/notejam/notejam:$COMMIT_SHA"
      - --region
      - us-central1
      - --platform
      - managed
      - --vpc-connector 
      - notejam-db-connector
      - --set-env-vars
      - "FLASK_ENV=testing,MAIL_USER=notejam@freistrom.io,POSTGRES_URL=10.44.0.3:5432,POSTGRES_DB=notejam-test-db"
      - --set-secrets=[POSTGRES_PW=password123!]
      - --port
      - '5000'
availableSecrets:
  secretManager:
  - versionName: projects/419101208491/secrets/POSTGRES_PW/versions/latest
    env: POSTGRES_PW
  - versionName: projects/419101208491/secrets/MAIL_PW/versions/latest
    env: MAIL_PW
images:
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/notejam/notejam:$COMMIT_SHA'
